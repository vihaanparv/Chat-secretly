<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Private Chat (DM)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for a cleaner look */
        #messages-container::-webkit-scrollbar {
            width: 6px;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 3px;
        }

        #messages-container {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f8fafc; /* thin, thumb, track */
        }
        
        .chat-container {
            height: calc(100vh - 10px); /* Adjust for full screen */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased p-2">

    <div id="app" class="chat-container max-w-4xl mx-auto flex flex-col shadow-2xl rounded-xl overflow-hidden bg-white">
        <!-- Header -->
        <header class="bg-indigo-600 p-4 shadow-lg flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-2xl font-bold text-white">Private Chat</h1>
                <p id="current-chat-display" class="text-sm text-indigo-200 mt-1"></p>
            </div>
            
            <div class="text-sm text-indigo-200 flex items-center">
                <span id="user-info-status" class="mr-2">Connecting...</span>
                <span id="user-id-display" class="font-mono bg-indigo-700 px-2 py-1 rounded-full text-xs shadow cursor-pointer" 
                      title="Click to copy your User ID for sharing" onclick="copyUserId()"></span>
            </div>
        </header>

        <!-- Manual ID Override (Hidden by default) -->
        <div id="manual-id-override" class="p-3 bg-yellow-100 text-yellow-800 hidden items-center justify-between shadow-inner">
            <p class="text-sm">Authentication failed or config invalid. Use a temporary local User ID?</p>
            <button id="set-manual-id-button" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-1 px-4 rounded-lg text-sm transition duration-200">
                Generate Local ID
            </button>
        </div>

        <!-- Messages Area -->
        <div id="messages-container" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
            <div id="initial-prompt" class="text-center p-8 text-gray-500 border border-dashed border-gray-300 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-3 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p class="mt-2 text-lg font-medium">Select a recipient below to start a private chat.</p>
                <p class="text-sm mt-1">Share your User ID with a friend so they can message you!</p>
            </div>
            <div id="loading-spinner" class="hidden text-center p-8 text-gray-500">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Loading messages...</p>
            </div>
            <!-- Messages will be injected here -->
        </div>

        <!-- Recipient and Message Input -->
        <div class="p-4 bg-white border-t border-gray-200 space-y-3">
            <div id="error-box" class="hidden p-2 bg-red-100 text-red-700 rounded-lg text-sm"></div>

            <!-- Recipient Selector Form -->
            <form id="recipient-form" class="flex space-x-3">
                <input type="text" id="recipient-input" placeholder="Enter Recipient's Full User ID" required 
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 shadow-inner" 
                       autocomplete="off">
                <button type="submit" id="set-recipient-button" disabled class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center">
                    Start Chat
                </button>
            </form>

            <!-- Message Input Form (Hidden initially) -->
            <form id="message-form" class="flex space-x-3" style="display: none;">
                <input type="text" id="message-input" placeholder="Type your private message..." required 
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-inner" 
                       autocomplete="off">
                <button type="submit" id="send-button" disabled class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    Send
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.323l.163.132A1 1 0 003 17h14a1 1 0 00.894-1.447l-7-14z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('Debug');

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let targetUserId = null; // New variable for the recipient
        let isAuthReady = false;
        let unsubscribe = null; // To hold the listener cleanup function

        // UI elements
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const errorBox = document.getElementById('error-box');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoStatus = document.getElementById('user-info-status');
        const loadingSpinner = document.getElementById('loading-spinner');
        const initialPrompt = document.getElementById('initial-prompt');
        const recipientForm = document.getElementById('recipient-form');
        const recipientInput = document.getElementById('recipient-input');
        const currentChatDisplay = document.getElementById('current-chat-display');
        const setRecipientButton = document.getElementById('set-recipient-button'); // Get this button for initial disabling

        // New elements for manual ID fallback
        const manualIdOverride = document.getElementById('manual-id-override');
        const setManualIdButton = document.getElementById('set-manual-id-button');
        
        // Disable recipient form initially until auth is ready
        setRecipientButton.disabled = true;

        // Utility function to get a deterministic chat ID
        function getChatId(id1, id2) {
            // Sort IDs alphabetically to ensure the chat ID is the same regardless of who starts it
            const sortedIds = [id1, id2].sort();
            return sortedIds.join('_');
        }
        
        // Utility function to copy the user ID
        window.copyUserId = function() {
            if (userId) {
                // Use execCommand for broader iframe compatibility
                const tempInput = document.createElement('textarea');
                tempInput.value = userId;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alertMessage(`Copied User ID: ${userId.substring(0, 8)}...`, 'bg-green-100 text-green-700');
            } else {
                alertMessage('User ID not ready yet.', 'bg-yellow-100 text-yellow-700');
            }
        };

        // Custom alert function (replaces window.alert)
        function alertMessage(message, classes) {
            const tempBox = document.createElement('div');
            tempBox.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 ${classes}`;
            tempBox.textContent = message;
            document.body.appendChild(tempBox);
            setTimeout(() => {
                tempBox.classList.add('opacity-0');
                tempBox.addEventListener('transitionend', () => tempBox.remove());
            }, 3000);
        }

        // --- Manual ID Fallback ---
        function setManualId() {
            // Generate a standard UUID as a fallback identifier
            userId = crypto.randomUUID(); 
            isAuthReady = true;

            // Update UI for manual mode
            userInfoStatus.textContent = "Local ID Active";
            userIdDisplay.textContent = userId.substring(0, 8) + '... (Local)';
            userIdDisplay.classList.remove('bg-indigo-700');
            userIdDisplay.classList.add('bg-yellow-600');
            manualIdOverride.classList.add('hidden');
            
            // Enable core functionality
            setRecipientButton.disabled = false;
            
            alertMessage("Using Local ID. Functionality is enabled, but persistence and true privacy may be limited.", 'bg-yellow-100 text-yellow-800');
        }

        // Attach listener for manual ID
        setManualIdButton.addEventListener('click', setManualId);

        // --- Core Application Logic ---

        // 1. Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                userInfoStatus.textContent = "Checking configuration...";
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                let firebaseConfig = {};
                let configString = '';
                
                // DEFENSIVE CHECK 1: Ensure __firebase_config exists and is a string
                if (typeof __firebase_config !== 'undefined' && typeof __firebase_config === 'string') {
                    configString = __firebase_config;
                } else {
                    throw new Error("Critical: __firebase_config variable is missing or not a string.");
                }

                // DEFENSIVE CHECK 2: Robust JSON parsing
                try {
                    firebaseConfig = JSON.parse(configString);
                } catch (e) {
                    console.error("Firebase Raw Config:", configString);
                    throw new Error("Configuration failed to parse. Received malformed JSON.");
                }

                // DEFENSIVE CHECK 3: Check for required key
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Parsed Firebase Config:", firebaseConfig);
                    throw new Error("Configuration object is valid but missing the required 'apiKey'.");
                }
                
                // Initialization successful, proceed
                userInfoStatus.textContent = "Initializing Firebase...";
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // SUCCESS PATH
                        userId = user.uid;
                        isAuthReady = true;
                        userInfoStatus.textContent = "Authenticated";
                        userIdDisplay.textContent = userId.substring(0, 8) + '...'; // Displaying first 8 chars of ID
                        setRecipientButton.disabled = false; // Enable form on successful auth
                        
                    } else {
                        // Attempt Sign in
                        try {
                            if (initialAuthToken) {
                                userInfoStatus.textContent = "Authenticating with Token...";
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                userInfoStatus.textContent = "Signing in Anonymously...";
                                await signInAnonymously(auth);
                            }
                            // The success of these awaits will trigger the 'if (user)' block above.
                        } catch (e) {
                            // AUTHENTICATION FAILED PATH
                            console.error("Authentication failed:", e);
                            displayError(`Authentication failed! (Error: ${e.code}). Please use a Local ID to proceed.`);
                            sendButton.disabled = true;
                            userInfoStatus.textContent = "Auth Failed";
                            manualIdOverride.classList.remove('hidden'); // Show manual override button
                            setRecipientButton.disabled = true; // Keep disabled until local ID is set
                        }
                    }
                });
            } catch (e) {
                // FIREBASE INIT FAILED PATH (e.g., config invalid)
                console.error("Firebase initialization error:", e);
                displayError(`Initialization Failed: ${e.message}`);
                userInfoStatus.textContent = "Init Error";
                manualIdOverride.classList.remove('hidden'); // Show manual override button
                setRecipientButton.disabled = true; // Keep disabled until local ID is set
            }
        }

        // 2. Recipient Selection Handler
        recipientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const recipientId = recipientInput.value.trim();

            if (!recipientId || !userId) {
                displayError("Please enter a valid recipient ID and ensure you are signed in.");
                return;
            }
            if (recipientId === userId) {
                displayError("You cannot chat with yourself. Please enter another user's ID.");
                return;
            }

            // Set the new target and update the UI/listener
            targetUserId = recipientId;
            setupMessageListener(targetUserId);

            // Update UI state
            messageForm.style.display = 'flex';
            sendButton.disabled = false;
            recipientInput.disabled = true;
            document.getElementById('set-recipient-button').classList.add('hidden'); // Hide the button
            currentChatDisplay.textContent = `Chatting with: ${targetUserId.substring(0, 8)}...`;
            errorBox.classList.add('hidden');
        });

        // 3. Real-time Message Listener (onSnapshot)
        function setupMessageListener(recipientId) {
            // NOTE: db will be null if Firebase initialization failed, but we still allow the recipient form to be used
            // This listener will only attach if db is available (i.e., Firebase init was successful).
            if (!isAuthReady || !recipientId) return;

            // 1. Clean up previous listener if it exists
            if (unsubscribe) {
                unsubscribe();
            }
            messagesContainer.innerHTML = ''; // Clear old messages
            initialPrompt.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            // If Firebase failed, we can't listen for real-time changes or save data.
            if (!db) {
                displayError("Real-time features are unavailable because Firebase failed to initialize. Data will not be saved or shared.");
                loadingSpinner.classList.add('hidden');
                messageForm.style.display = 'none'; // Hide the message input if we can't send
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
            const chatId = getChatId(userId, recipientId);
            
            // CORRECTED PATH for collaborative data: /artifacts/{appId}/public/data/private_chats/{chatId}/messages
            const chatCollectionPath = `artifacts/${appId}/public/data/private_chats/${chatId}/messages`;
            
            const q = query(
                collection(db, chatCollectionPath),
                orderBy('timestamp', 'asc')
            );

            // 2. Attach new listener
            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                const shouldScroll = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 50;

                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const message = change.doc.data();
                        addMessageToUI(message);
                    }
                });

                if (shouldScroll) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                displayError("Failed to fetch messages. Check your connection or recipient ID.");
                loadingSpinner.classList.add('hidden');
            });

            // Re-show the send form if the listener was successfully set up
            messageForm.style.display = 'flex';
            sendButton.disabled = false;
        }

        // 4. Send Message Handler
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (!text || !userId || !targetUserId) {
                return;
            }
            
            // Check if db is initialized before attempting to send
            if (!db) {
                displayError("Cannot send message: Firebase is not initialized. Please refresh or use a working configuration.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
                const chatId = getChatId(userId, targetUserId);
                
                // CORRECTED PATH for collaborative data: /artifacts/{appId}/public/data/private_chats/{chatId}/messages
                const chatCollectionPath = `artifacts/${appId}/public/data/private_chats/${chatId}/messages`;

                await addDoc(collection(db, chatCollectionPath), {
                    senderId: userId,
                    text: text,
                    timestamp: serverTimestamp()
                });

                messageInput.value = ''; // Clear input on success
                errorBox.classList.add('hidden'); // Clear any previous error

            } catch (e) {
                console.error("Error sending message:", e);
                displayError("Could not send message. Check Firestore rules or recipient ID.");
            }
        });

        // 5. UI Rendering Functions
        function addMessageToUI(message) {
            const isSelf = message.senderId === userId;
            const msgDiv = document.createElement('div');
            const formattedTime = message.timestamp?.toDate ? formatTimestamp(message.timestamp.toDate()) : '...';

            // Determine bubble style based on sender
            const alignmentClass = isSelf ? 'self-end items-end' : 'self-start items-start';
            const colorClass = isSelf ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800';
            const roundedClass = isSelf ? 'rounded-tl-xl rounded-tr-lg rounded-bl-xl rounded-br-lg' : 'rounded-tr-xl rounded-tl-lg rounded-br-xl rounded-bl-lg';

            msgDiv.className = `flex flex-col max-w-[80%] md:max-w-[60%] ${alignmentClass}`;
            msgDiv.innerHTML = `
                <div class="text-xs font-semibold ${isSelf ? 'text-indigo-700' : 'text-gray-500'} mb-1">
                    ${isSelf ? 'You' : message.senderId.substring(0, 8) + '...'}
                </div>
                <div class="px-4 py-2 shadow-md ${colorClass} ${roundedClass} break-words">
                    ${escapeHTML(message.text)}
                </div>
                <div class="text-xs text-gray-400 mt-1">${formattedTime}</div>
            `;

            messagesContainer.appendChild(msgDiv);
        }

        function formatTimestamp(date) {
            if (!date) return '';
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleTimeString('en-US', options);
        }

        function displayError(message) {
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        // --- Start the app ---
        window.onload = initializeFirebase;
    </script>

</body>
</html>
